<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raccolta Dati GPS e Suono</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
            background: white;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #217346;
        }
        
        input[type="number"]:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        select {
            cursor: pointer;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-start {
            background: #2563eb;
        }
        
        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
            background: #1d4ed8;
        }
        
        .btn-stop {
            background: #dc2626;
        }
        
        .btn-stop:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
            background: #b91c1c;
        }
        
        .btn-export {
            background: #217346;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 115, 70, 0.5);
            background: #1a5c37;
        }
        
        .btn-clear {
            background: #6b7280;
        }
        
        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
            background: #4b5563;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
        }
        
        .status-value {
            color: #217346;
            font-weight: 700;
        }
        
        .data-table {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            background: white;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #217346;
            color: white;
            padding: 14px 12px;
            text-align: left;
            position: sticky;
            top: 0;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-right: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
        }
        
        th:last-child {
            border-right: none;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            border-right: 1px solid #f3f4f6;
            font-size: 14px;
            color: #374151;
        }
        
        td:last-child {
            border-right: none;
        }
        
        tr:hover td {
            background: #f0fdf4;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #ff4757;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c00;
        }
        
        .lang-selector {
            text-align: right;
            margin-bottom: 15px;
        }
        
        .lang-selector select {
            padding: 8px 12px;
            border: 2px solid #217346;
            border-radius: 8px;
            background: white;
            color: #217346;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .lang-selector select:hover {
            background: #217346;
            color: white;
        }
        
        .lang-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 115, 70, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-selector">
            <select id="langSelect">
                <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
                <option value="en">ðŸ‡¬ðŸ‡§ English</option>
            </select>
        </div>
        
        <h1 id="title"><i class="bi bi-geo-alt-fill"></i> Raccolta Dati GPS e Suono <i class="bi bi-soundwave"></i></h1>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div class="settings">
            <div class="setting-group">
                <label for="mode" id="labelMode">ModalitÃ  di raccolta:</label>
                <select id="mode">
                    <option value="walking">A piedi (3 sec)</option>
                    <option value="cycling">In bicicletta (2 sec)</option>
                    <option value="driving">In auto (2 sec)</option>
                    <option value="stationary">Punto fisso (30 sec)</option>
                    <option value="long">Lunga durata (60 sec)</option>
                    <option value="custom">Manuale</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="freq" id="labelFreq">Frequenza (secondi):</label>
                <input type="number" id="freq" min="1" max="3600" value="3" step="1" disabled>
            </div>
        </div>
        
        <div class="controls">
            <button id="btnStart" class="btn-start"><i class="bi bi-play-fill"></i> Avvia Raccolta</button>
            <button id="btnStop" class="btn-stop" disabled><i class="bi bi-stop-fill"></i> Ferma Raccolta</button>
        </div>
        
        <div class="controls">
            <button id="btnExport" class="btn-export"><i class="bi bi-download"></i> Esporta CSV</button>
            <button id="btnClear" class="btn-clear"><i class="bi bi-trash-fill"></i> Cancella Dati</button>
        </div>
        
        <div class="status">
            <div class="status-item">
                <span class="status-label" id="labelStatus">Stato:</span>
                <span class="status-value" id="status">In attesa</span>
            </div>
            <div class="status-item">
                <span class="status-label" id="labelCount">Dati raccolti:</span>
                <span class="status-value" id="count">0</span>
            </div>
            <div class="status-item">
                <span class="status-label" id="labelLastGPS">Ultima posizione:</span>
                <span class="status-value" id="gps">-</span>
            </div>
            <div class="status-item">
                <span class="status-label" id="labelLastSound">Ultimo livello suono:</span>
                <span class="status-value" id="sound">-</span>
            </div>
        </div>
        
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th id="thTime">Timestamp</th>
                        <th id="thLat">Latitudine</th>
                        <th id="thLng">Longitudine</th>
                        <th id="thDB">Livello dB</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;" id="nodata">Nessun dato raccolto</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Traduzioni / Translations
        var txt = {
            it: {
                title: '<i class="bi bi-geo-alt-fill"></i> Raccolta Dati GPS e Suono <i class="bi bi-soundwave"></i>',
                labelMode: 'ModalitÃ  di raccolta:',
                labelFreq: 'Frequenza (secondi):',
                modeWalking: 'A piedi (3 sec)',
                modeCycling: 'In bicicletta (2 sec)',
                modeDriving: 'In auto (2 sec)',
                modeStationary: 'Punto fisso (30 sec)',
                modeLong: 'Lunga durata (60 sec)',
                modeCustom: 'Manuale',
                btnStart: '<i class="bi bi-play-fill"></i> Avvia Raccolta',
                btnStop: '<i class="bi bi-stop-fill"></i> Ferma Raccolta',
                btnExport: '<i class="bi bi-download"></i> Esporta CSV',
                btnClear: '<i class="bi bi-trash-fill"></i> Cancella Dati',
                labelStatus: 'Stato:',
                labelCount: 'Dati raccolti:',
                labelLastGPS: 'Ultima posizione:',
                labelLastSound: 'Ultimo livello suono:',
                thTime: 'Timestamp',
                thLat: 'Latitudine',
                thLng: 'Longitudine',
                thDB: 'Livello dB',
                nodata: 'Nessun dato raccolto',
                waiting: 'In attesa',
                recording: 'Registrazione in corso',
                stopped: 'Fermato',
                errMic: 'Errore accesso microfono: ',
                errGPS: 'GPS non supportato',
                errCollect: 'Errore raccolta dati: ',
                errNoData: 'Nessun dato da esportare',
                confirmClear: 'Sei sicuro di voler cancellare tutti i dati raccolti?',
                csvFile: 'dati_gps_suono',
                csvTime: 'Data_Ora',
                csvLat: 'Latitudine',
                csvLng: 'Longitudine',
                csvDB: 'Livello_dB'
            },
            en: {
                title: '<i class="bi bi-geo-alt-fill"></i> GPS and Sound Data Collection <i class="bi bi-soundwave"></i>',
                labelMode: 'Collection mode:',
                labelFreq: 'Frequency (seconds):',
                modeWalking: 'Walking (3 sec)',
                modeCycling: 'Cycling (2 sec)',
                modeDriving: 'Driving (2 sec)',
                modeStationary: 'Fixed point (30 sec)',
                modeLong: 'Long duration (60 sec)',
                modeCustom: 'Manual',
                btnStart: '<i class="bi bi-play-fill"></i> Start Collection',
                btnStop: '<i class="bi bi-stop-fill"></i> Stop Collection',
                btnExport: '<i class="bi bi-download"></i> Export CSV',
                btnClear: '<i class="bi bi-trash-fill"></i> Clear Data',
                labelStatus: 'Status:',
                labelCount: 'Data collected:',
                labelLastGPS: 'Last position:',
                labelLastSound: 'Last sound level:',
                thTime: 'Timestamp',
                thLat: 'Latitude',
                thLng: 'Longitude',
                thDB: 'Level dB',
                nodata: 'No data collected',
                waiting: 'Waiting',
                recording: 'Recording in progress',
                stopped: 'Stopped',
                errMic: 'Microphone access error: ',
                errGPS: 'GPS not supported',
                errCollect: 'Data collection error: ',
                errNoData: 'No data to export',
                confirmClear: 'Are you sure you want to delete all collected data?',
                csvFile: 'gps_sound_data',
                csvTime: 'DateTime',
                csvLat: 'Latitude',
                csvLng: 'Longitude',
                csvDB: 'Sound_Level_dB'
            }
        };
        
        // Frequenze preset / Preset frequencies
        var freqs = { walking: 3, cycling: 2, driving: 2, stationary: 30, long: 60 };
        
        // Variabili di stato / State variables
        var recording = false;
        var interval = null;
        var ctx = null;
        var analyzer = null;
        var mic = null;
        var freqData = null;
        var data = [];
        var lang = 'it';
        
        // Riferimenti agli elementi DOM / DOM element references
        var elemMode = document.getElementById('mode');
        var elemFreq = document.getElementById('freq');
        var elemStart = document.getElementById('btnStart');
        var elemStop = document.getElementById('btnStop');
        var elemExport = document.getElementById('btnExport');
        var elemClear = document.getElementById('btnClear');
        var elemLang = document.getElementById('langSelect');
        var elemStatus = document.getElementById('status');
        var elemCount = document.getElementById('count');
        var elemGPS = document.getElementById('gps');
        var elemSound = document.getElementById('sound');
        var elemTbody = document.getElementById('tbody');
        var elemError = document.getElementById('error');
        
        // Gestione cambio modalitÃ  / Mode change handler
        elemMode.addEventListener('change', function() {
            var m = elemMode.value;
            if (m === 'custom') {
                elemFreq.disabled = false;
            } else {
                elemFreq.value = freqs[m];
                elemFreq.disabled = true;
            }
        });
        
        // Gestione cambio lingua / Language change handler
        elemLang.addEventListener('change', function() {
            updateLang(elemLang.value);
        });
        
        // Aggiorna testi interfaccia / Update UI texts
        function updateLang(l) {
            lang = l;
            var t = txt[l];
            
            document.getElementById('title').innerHTML = t.title;
            document.getElementById('labelMode').textContent = t.labelMode;
            document.getElementById('labelFreq').textContent = t.labelFreq;
            
            var opts = elemMode.options;
            opts[0].text = t.modeWalking;
            opts[1].text = t.modeCycling;
            opts[2].text = t.modeDriving;
            opts[3].text = t.modeStationary;
            opts[4].text = t.modeLong;
            opts[5].text = t.modeCustom;
            
            elemStart.innerHTML = t.btnStart;
            elemStop.innerHTML = t.btnStop;
            elemExport.innerHTML = t.btnExport;
            elemClear.innerHTML = t.btnClear;
            
            document.getElementById('labelStatus').textContent = t.labelStatus;
            document.getElementById('labelCount').textContent = t.labelCount;
            document.getElementById('labelLastGPS').textContent = t.labelLastGPS;
            document.getElementById('labelLastSound').textContent = t.labelLastSound;
            
            document.getElementById('thTime').textContent = t.thTime;
            document.getElementById('thLat').textContent = t.thLat;
            document.getElementById('thLng').textContent = t.thLng;
            document.getElementById('thDB').textContent = t.thDB;
            
            if (!recording) {
                elemStatus.textContent = t.waiting;
            }
            
            var nd = document.getElementById('nodata');
            if (nd) {
                nd.textContent = t.nodata;
            }
        }
        
        // Mostra messaggio di errore / Show error message
        function showErr(msg) {
            elemError.textContent = msg;
            elemError.style.display = 'block';
            setTimeout(function() {
                elemError.style.display = 'none';
            }, 5000);
        }
        
        // Inizializza accesso microfono / Initialize microphone access
        function setupAudio() {
            return new Promise(function(resolve) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        ctx = new (window.AudioContext || window.webkitAudioContext)();
                        analyzer = ctx.createAnalyser();
                        mic = ctx.createMediaStreamSource(stream);
                        analyzer.fftSize = 256;
                        freqData = new Uint8Array(analyzer.frequencyBinCount);
                        mic.connect(analyzer);
                        resolve(true);
                    })
                    .catch(function(err) {
                        showErr(txt[lang].errMic + err.message);
                        resolve(false);
                    });
            });
        }
        
        // Calcola livello sonoro in dB / Calculate sound level in dB
        function getDB() {
            if (!analyzer || !freqData) return 0;
            analyzer.getByteFrequencyData(freqData);
            var sum = 0;
            for (var i = 0; i < freqData.length; i++) {
                sum += freqData[i];
            }
            var avg = sum / freqData.length;
            var db = 20 * Math.log10(avg / 255) + 100;
            return Math.max(0, Math.min(100, db)).toFixed(1);
        }
        
        // Ottieni coordinate GPS / Get GPS coordinates
        function getGPS() {
            return new Promise(function(resolve, reject) {
                if (!navigator.geolocation) {
                    reject(new Error(txt[lang].errGPS));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        resolve({
                            lat: pos.coords.latitude.toFixed(6),
                            lng: pos.coords.longitude.toFixed(6)
                        });
                    },
                    function(err) {
                        reject(err);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        // Raccolta dati / Data gathering
        function collect() {
            getGPS()
                .then(function(gps) {
                    var db = getDB();
                    var ts = new Date().toISOString();
                    var point = { timestamp: ts, lat: gps.lat, lng: gps.lng, db: db };
                    data.push(point);
                    updateUI(point);
                })
                .catch(function(err) {
                    showErr(txt[lang].errCollect + err.message);
                });
        }
        
        // Aggiorna interfaccia con nuovi dati / Update UI with new data
        function updateUI(point) {
            elemCount.textContent = data.length;
            elemGPS.textContent = point.lat + ', ' + point.lng;
            elemSound.textContent = point.db + ' dB';
            
            if (elemTbody.querySelector('td[colspan="4"]')) {
                elemTbody.innerHTML = '';
            }
            
            var row = document.createElement('tr');
            row.innerHTML = '<td>' + new Date(point.timestamp).toLocaleString() + '</td>' +
                           '<td>' + point.lat + '</td>' +
                           '<td>' + point.lng + '</td>' +
                           '<td>' + point.db + ' dB</td>';
            elemTbody.insertBefore(row, elemTbody.firstChild);
        }
        
        // Avvia raccolta dati / Start data collection
        elemStart.addEventListener('click', function() {
            if (recording) return;
            
            setupAudio().then(function(ok) {
                if (!ok) return;
                
                recording = true;
                elemStart.disabled = true;
                elemStop.disabled = false;
                elemMode.disabled = true;
                elemFreq.disabled = true;
                
                elemStatus.innerHTML = txt[lang].recording + ' <span class="recording-indicator"></span>';
                
                collect();
                var freq = parseInt(elemFreq.value) * 1000;
                interval = setInterval(collect, freq);
            });
        });
        
        // Ferma raccolta dati / Stop data collection
        elemStop.addEventListener('click', function() {
            if (!recording) return;
            
            recording = false;
            elemStart.disabled = false;
            elemStop.disabled = true;
            elemMode.disabled = false;
            
            if (elemMode.value === 'custom') {
                elemFreq.disabled = false;
            }
            
            if (interval) {
                clearInterval(interval);
                interval = null;
            }
            
            if (mic) {
                mic.disconnect();
                mic = null;
            }
            
            if (ctx) {
                ctx.close();
                ctx = null;
            }
            
            elemStatus.textContent = txt[lang].stopped;
        });
        
        // Esporta dati in CSV / Export data to CSV
        elemExport.addEventListener('click', function() {
            if (data.length === 0) {
                showErr(txt[lang].errNoData);
                return;
            }
            
            var t = txt[lang];
            var csv = t.csvTime + ',' + t.csvLat + ',' + t.csvLng + ',' + t.csvDB + '\n';
            
            for (var i = 0; i < data.length; i++) {
                var p = data[i];
                csv += p.timestamp + ',' + p.lat + ',' + p.lng + ',' + p.db + '\n';
            }
            
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            var ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            var filename = t.csvFile + '_' + ts + '.csv';
            
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Cancella tutti i dati / Clear all data
        elemClear.addEventListener('click', function() {
            if (confirm(txt[lang].confirmClear)) {
                data = [];
                elemTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;" id="nodata">' + txt[lang].nodata + '</td></tr>';
                elemCount.textContent = '0';
                elemGPS.textContent = '-';
                elemSound.textContent = '-';
            }
        });
    </script>
</body>
</html>
